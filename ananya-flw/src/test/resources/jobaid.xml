<?xml version="1.0" encoding="UTF-8"?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.w3.org/2001/vxml http://www.w3.org/TR/voicexml21/vxml.xsd">

    <!-- TODO: How do we handle if any of the following fetches fail? -->
    <script src="./js/metadata.js"/>
    <script src="./js/course_data.js"/>

    <script src="./js/course.js"/>
    <script src="./js/call_context.js"/>
    <script>
        <![CDATA[
            var callContext = new CallContext(courseData, metaData);
        ]]>
    </script>
    <!--Should see if the property setting can be configuration driven, or if this could be set as a session variable-->
    <property name="timeout" value="3s"/>

    <form id="controller">
        <script>
            callContext.resetPromptCounts();
        </script>
        <block>
            <if cond="callContext.isAtALesson()">
                <goto next="#lesson"/>
            <else/>
                <goto next="#genericLevel"/>
            </if>
        </block>
    </form>

    <form id="genericLevel">
        <block name="introduction">
           <audio expr="callContext.currentInteractionIntroduction()"/>
        </block>

        <field name="nextLevelSelection" >
            <prompt>
                <audio expr="callContext.currentInteractionMenu()"/>
            </prompt>

            <grammar mode="dtmf" version="1.0" root="root">
                <rule id="root">
                    <one-of>
                        <item>0</item>
                        <item>1</item>
                        <item>2</item>
                        <item>3</item>
                        <item>4</item>
                        <item>5</item>
                        <item>6</item>
                        <item>7</item>
                        <item>8</item>
                        <item>9</item>
                        <item>*</item>
                        <item>#</item>
                    </one-of>
                </rule>
              </grammar>

            <noinput>
                <goto nextitem="noInputAction"/>
            </noinput>

            <filled>
                <if cond="callContext.isValidInput(nextLevelSelection)">
                    <script>
                        callContext.handleInput(nextLevelSelection);
                    </script>
                    <goto next="#controller"/>
                <else/>
                    <goto nextitem="invalidInputAction"/>
                </if>
            </filled>
        </field>

        <block name="noInputAction">
            <script>
                callContext.incrementNoInputCount();
            </script>
            <if cond="callContext.hasExceededMaxNoInputs()">
                <audio expr="metaData.noInputDisconnectAudio"/>
                <disconnect/>
            <else/>
                Going to play: <value expr="metaData.noInputRetryAudio"/>.
                <audio expr="metaData.noInputRetryAudio"/>
                <reprompt/>
            </if>
        </block>

        <block name="invalidInputAction">
            <script>
                callContext.incrementInvalidInputCount();
            </script>
            <if cond="callContext.hasExceededMaxInvalidInputs()">
                <audio expr="metaData.invalidInputDisconnectAudio"/>
                <disconnect/>
            <else/>
                <audio expr="metaData.invalidInputRetryAudio"/>
                <goto nextitem="nextLevelSelection"/>
            </if>
        </block>
    </form>

    <form id="lesson">
        <block>
            <audio expr="callContext.currentInteractionLesson()"/>
            <script>
                callContext.lessonFinished();
            </script>
            <goto next="#controller"/>
        </block>
    </form>
</vxml>




